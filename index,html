<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7월 / 8월 당번 그룹 배정</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    input, button { padding: 10px 16px; font-size: 16px; margin: 6px; cursor: pointer; }
    #result { margin-top: 14px; font-size: 20px; font-weight: 700; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .muted { color:#666; font-size: 13px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 18px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; text-align: left; }
    .title { font-weight: 800; margin-bottom: 6px; }
    ul { margin: 6px 0 0; padding-left: 18px; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>7월 / 8월 그룹 배정</h2>
  <p class="muted">이름 입력하면 자동 배정됩니다. (총 18명 / 7월 9명, 8월 9명)</p>

  <input id="nameInput" placeholder="이름 입력" />
  <button id="assignBtn" onclick="assign()">배정 받기</button>
  <button onclick="resetAll()">리셋</button>

  <div id="result"></div>
  <div class="muted" id="countInfo"></div>

  <div class="grid">
    <div class="card">
      <div class="title">7월 (9명)</div>
      <ul id="julyList"></ul>
    </div>

    <div class="card">
      <div class="title">8월 (9명)</div>
      <ul id="augList"></ul>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <div class="title">전체 배정표</div>
      <div class="muted">모든 참가자의 배정이 실시간으로 반영됩니다.</div>
      <ul id="allList" style="margin-top:10px;"></ul>
    </div>
  </div>
</div>

<script>
  // ✅ 기존 Firebase 그대로 써도 되고
  const firebaseConfig = {
    apiKey: "AIzaSyAi89e-UbIewoENV4MH-kz_DKYJkP9Z2AA",
    authDomain: "index-8ed43.firebaseapp.com",
    databaseURL: "https://index-8ed43-default-rtdb.firebaseio.com",
    projectId: "index-8ed43",
    storageBucket: "index-8ed43.firebasestorage.app",
    messagingSenderId: "518664000525",
    appId: "1:518664000525:web:79958f1fbf2e1feb8b7144"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ✅ 청소구역이랑 안 섞이게 경로 분리
  const ROOT = "monthGroups"; // <- 이 폴더만 바꾸면 다른 용도로 재사용 가능

  // 슬롯: 7월 9명 / 8월 9명
  const initialSlots = { "7월": 9, "8월": 9 };
  const MAX = 18;

  // 최초 1회 초기화
  db.ref(`${ROOT}/assignments`).get().then(snap => {
    if (!snap.exists()) {
      db.ref(`${ROOT}/assignments`).set({});
      db.ref(`${ROOT}/slots`).set(initialSlots);
      console.log("초기화 완료");
    }
  });

  function assign(){
    const name = document.getElementById("nameInput").value.trim();
    const result = document.getElementById("result");

    if(!name){
      result.style.color = "#c62828";
      result.innerText = "이름 입력해줘!";
      return;
    }

    db.ref(`${ROOT}/assignments`).once("value").then(snap => {
      let assignments = snap.val() || {};

      if(assignments[name]){
        result.style.color = "#2e7d32";
        result.innerText = `${name} → ${assignments[name]}`;
        return;
      }

      if(Object.keys(assignments).length >= MAX){
        result.style.color = "#c62828";
        result.innerText = "18명 배정이 완료되었습니다!";
        return;
      }

      db.ref(`${ROOT}/slots`).transaction((slots) => {
        if(!slots) return;

        const available = Object.entries(slots).filter(([k,v]) => v > 0);
        if(available.length === 0) return;

        const pick = available[Math.floor(Math.random()*available.length)];
        const selected = pick[0];
        slots[selected]--;

        return slots;
      }, (error, committed, slotSnap) => {
        if(error || !committed){
          result.style.color = "#c62828";
          result.innerText = "배정 중 오류! 다시 눌러줘.";
          return;
        }

        const updated = slotSnap.val();

        // 어떤 슬롯이 줄었는지로 배정 결과 판별 (청소구역 로직 재활용)
        const assigned = Object.keys(initialSlots).find(k => {
          const used = initialSlots[k] - updated[k];
          const current = Object.values(assignments).filter(v => v === k).length;
          return used > current;
        });

        if(!assigned){
          result.style.color = "#c62828";
          result.innerText = "할당할 그룹이 없습니다.";
          return;
        }

        assignments[name] = assigned;
        db.ref(`${ROOT}/assignments`).set(assignments);

        result.style.color = "#2e7d32";
        result.innerText = `${name} → ${assigned}`;
        document.getElementById("nameInput").value = "";
        document.getElementById("nameInput").focus();
      });
    });
  }

  function resetAll(){
    db.ref(`${ROOT}/slots`).set(initialSlots);
    db.ref(`${ROOT}/assignments`).set({});
    document.getElementById("result").style.color = "#2e7d32";
    document.getElementById("result").innerText = "초기화 완료!";
  }

  function fillList(id, arr){
    const ul = document.getElementById(id);
    ul.innerHTML = "";
    if(arr.length === 0){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "(없음)";
      ul.appendChild(li);
      return;
    }
    arr.forEach(n => {
      const li = document.createElement("li");
      li.textContent = n;
      ul.appendChild(li);
    });
  }

  // 실시간 반영
  db.ref(`${ROOT}/assignments`).on("value", snap => {
    const assignments = snap.val() || {};
    const names = Object.keys(assignments);

    const july = [];
    const aug = [];

    names.forEach(n => {
      if(assignments[n] === "7월") july.push(n);
      else if(assignments[n] === "8월") aug.push(n);
    });

    fillList("julyList", july);
    fillList("augList", aug);

    const all = document.getElementById("allList");
    all.innerHTML = "";
    names.forEach(n => {
      const li = document.createElement("li");
      li.textContent = `${n}: ${assignments[n]}`;
      all.appendChild(li);
    });

    document.getElementById("countInfo").textContent = `총 배정 인원: ${names.length}명 / ${MAX}명`;

    // 18명 채우면 버튼 잠금
    const btn = document.getElementById("assignBtn");
    if(names.length >= MAX){
      btn.disabled = true;
      btn.textContent = "배정 완료됨";
    }else{
      btn.disabled = false;
      btn.textContent = "배정 받기";
    }
  });
</script>
</body>
</html>
